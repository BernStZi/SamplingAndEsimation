<<<<<<< HEAD
nh.pr <- round(Nh.tab/sum(Nh.vec)*n)
#optimal
V.h   <- tapply(POP$api99,POP$stype,sd)[tab.names]
nh.op <- round((Nh.tab*V.h)/(sum(Nh.tab*V.h))*n)
##select sample
strSR.sample <- function(strind, nh, replace=FALSE){
Nh   <- table(strind)[names(nh)]
h.id <- split(1:sum(Nh), strind)[names(nh)]
sam <- mapply(function(x,y) sample(x, y, replace=replace), Nh, nh, SIMPLIFY = F)
sam <- unlist(mapply(function(x,y) x[y]
, h.id
, sam, SIMPLIFY = F))
sam
}
set.seed(4356)
s.eq <- strSR.sample(POP$stype, nh.eq, replace=FALSE)
s.pr <- strSR.sample(POP$stype, nh.pr, replace=FALSE)
s.op <- strSR.sample(POP$stype, nh.op, replace=FALSE)
strSRS.eq <- POP[s.eq,]
strSRS.pr <- POP[s.pr,]
strSRS.op <- POP[s.op,]
#options(survey.lonely.psu="adjust")
svystrSRS.eq <- svydesign(ids=~cds, strata =~strind,  fpc=~Nh, data=strSRS.eq)
svystrSRS.pr <- svydesign(ids=~cds, strata =~strind,  fpc=~Nh, data=strSRS.pr)
svystrSRS.op <- svydesign(ids=~cds, strata =~strind,  fpc=~Nh, data=strSRS.op)
c( eq=SE(svymean(~api00, svystrSRS.eq))
,pr=SE(svymean(~api00, svystrSRS.pr))
,op=SE(svymean(~api00, svystrSRS.op))
)
SE(svymean(~api00, svystrSRS.eq))
SE(svymean(~api00, svystrSRS.pr))
SE(svymean(~api00, svystrSRS.op))
table(POP$strind)[POP$strind]
POP <- apipop
POP$qapi99 <- cut(POP$api99, quantile(POP$api99), include.lowest = T)
POP$Nh    <- table(POP$strind)[POP$stype]
Nh.tab  <- table(POP$stype)
Nh.vec  <- as.vector(Nh)
tab.names <- apply(expand.grid(dimnames(Nh.tab)),1,paste,collapse="_")
names(Nh.vec) <- tab.names
mosaicplot(Nh.tab)
#sample size
n <- 60 #ceiling(dim(POP)[1]*0.01)
##allocations
#equal
nh.eq <-  rep(n/length(Nh.tab),length(Nh.tab))
names(nh.eq) <- tab.names
#proportional
nh.pr <- round(Nh.tab/sum(Nh.vec)*n)
#optimal
V.h   <- tapply(POP$api99,POP$stype,sd)[tab.names]
nh.op <- round((Nh.tab*V.h)/(sum(Nh.tab*V.h))*n)
##select sample
strSR.sample <- function(strind, nh, replace=FALSE){
Nh   <- table(strind)[names(nh)]
h.id <- split(1:sum(Nh), strind)[names(nh)]
sam <- mapply(function(x,y) sample(x, y, replace=replace), Nh, nh, SIMPLIFY = F)
sam <- unlist(mapply(function(x,y) x[y]
, h.id
, sam, SIMPLIFY = F))
sam
}
s.eq <- strSR.sample(POP$stype, nh.eq, replace=FALSE)
s.pr <- strSR.sample(POP$stype, nh.pr, replace=FALSE)
s.op <- strSR.sample(POP$stype, nh.op, replace=FALSE)
strSRS.eq <- POP[s.eq,]
strSRS.pr <- POP[s.pr,]
strSRS.op <- POP[s.op,]
table(strSRS.op$stype)
table(strSRS.pr$stype)
svystrSRS.eq <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.eq)
svystrSRS.pr <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.pr)
svystrSRS.op <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.op)
c( eq=SE(svymean(~api00, svystrSRS.eq))
,pr=SE(svymean(~api00, svystrSRS.pr))
,op=SE(svymean(~api00, svystrSRS.op))
)
strSRS.eq$Nh
POP <- apipop
POP$qapi99 <- cut(POP$api99, quantile(POP$api99), include.lowest = T)
POP$Nh    <- table(POP$stype)[POP$stype]
Nh.tab  <- table(POP$stype)
Nh.vec  <- as.vector(Nh)
tab.names <- apply(expand.grid(dimnames(Nh.tab)),1,paste,collapse="_")
names(Nh.vec) <- tab.names
mosaicplot(Nh.tab)
#sample size
n <- 60 #ceiling(dim(POP)[1]*0.01)
##allocations
#equal
nh.eq <-  rep(n/length(Nh.tab),length(Nh.tab))
names(nh.eq) <- tab.names
#proportional
nh.pr <- round(Nh.tab/sum(Nh.vec)*n)
#optimal
V.h   <- tapply(POP$api99,POP$stype,sd)[tab.names]
nh.op <- round((Nh.tab*V.h)/(sum(Nh.tab*V.h))*n)
##select sample
strSR.sample <- function(strind, nh, replace=FALSE){
Nh   <- table(strind)[names(nh)]
h.id <- split(1:sum(Nh), strind)[names(nh)]
sam <- mapply(function(x,y) sample(x, y, replace=replace), Nh, nh, SIMPLIFY = F)
sam <- unlist(mapply(function(x,y) x[y]
, h.id
, sam, SIMPLIFY = F))
sam
}
R <- 2000
set.seed(4356)
s.eq <- strSR.sample(POP$stype, nh.eq, replace=FALSE)
s.pr <- strSR.sample(POP$stype, nh.pr, replace=FALSE)
s.op <- strSR.sample(POP$stype, nh.op, replace=FALSE)
strSRS.eq <- POP[s.eq,]
strSRS.pr <- POP[s.pr,]
strSRS.op <- POP[s.op,]
#options(survey.lonely.psu="adjust")
svystrSRS.eq <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.eq)
svystrSRS.pr <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.pr)
svystrSRS.op <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.op)
c( eq=SE(svymean(~api00, svystrSRS.eq))
,pr=SE(svymean(~api00, svystrSRS.pr))
,op=SE(svymean(~api00, svystrSRS.op))
)
set.seed(4356)
s.eq <- strSR.sample(POP$stype, nh.eq, replace=FALSE)
s.pr <- strSR.sample(POP$stype, nh.pr, replace=FALSE)
s.op <- strSR.sample(POP$stype, nh.op, replace=FALSE)
strSRS.eq <- POP[s.eq,]
strSRS.pr <- POP[s.pr,]
strSRS.op <- POP[s.op,]
#options(survey.lonely.psu="adjust")
svystrSRS.eq <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.eq)
svystrSRS.pr <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.pr)
svystrSRS.op <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.op)
c( eq=SE(svymean(~api00, svystrSRS.eq))
,pr=SE(svymean(~api00, svystrSRS.pr))
,op=SE(svymean(~api00, svystrSRS.op))
)
svymean(~api00, svystrSRS.eq)
svymean(~api00, svystrSRS.pr)
svymean(~api00, svystrSRS.op)
set.seed(2345)
s.eq <- strSR.sample(POP$stype, nh.eq, replace=FALSE)
s.pr <- strSR.sample(POP$stype, nh.pr, replace=FALSE)
s.op <- strSR.sample(POP$stype, nh.op, replace=FALSE)
strSRS.eq <- POP[s.eq,]
strSRS.pr <- POP[s.pr,]
strSRS.op <- POP[s.op,]
#options(survey.lonely.psu="adjust")
svystrSRS.eq <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.eq)
svystrSRS.pr <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.pr)
svystrSRS.op <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.op)
c( eq=SE(svymean(~api00, svystrSRS.eq))
,pr=SE(svymean(~api00, svystrSRS.pr))
,op=SE(svymean(~api00, svystrSRS.op))
)
set.seed(1133)
s.eq <- strSR.sample(POP$stype, nh.eq, replace=FALSE)
s.pr <- strSR.sample(POP$stype, nh.pr, replace=FALSE)
s.op <- strSR.sample(POP$stype, nh.op, replace=FALSE)
strSRS.eq <- POP[s.eq,]
strSRS.pr <- POP[s.pr,]
strSRS.op <- POP[s.op,]
#options(survey.lonely.psu="adjust")
svystrSRS.eq <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.eq)
svystrSRS.pr <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.pr)
svystrSRS.op <- svydesign(ids=~cds, strata =~stype,  fpc=~Nh, data=strSRS.op)
c( eq=SE(svymean(~api00, svystrSRS.eq))
,pr=SE(svymean(~api00, svystrSRS.pr))
,op=SE(svymean(~api00, svystrSRS.op))
)
rm(list=ls())
source('~/.active-rstudio-document', echo=TRUE)
)
data(api)
MarginTab  <- table(apipop[,c("stype","sch.wide")])
MarginTab. <- cbind(MarginTab, SUM=rowSums(MarginTab))
MarginTab. <- rbind(MarginTab.,SUM=colSums(MarginTab.))
xtab <- xtable(MarginTab.,digits = 0
,caption = "Population Counts $\\tau_{x_q}$ for School Type (\\texttt{stype}) and School Target (\\texttt{sch.wide}) ")
align(xtab)<- "l|rr|r"
library(PracTools) #load the package
data(smho.N874)    #load the data set
head(smho.N874)
smho <- smho.N874[smho.N874$hosp.type != 4, ]
pairs.chrt <-
ggpairs(smho,columns = which(colnames(smho)%in%c("EXPTOTAL","BEDS","SEENCNT","EOYCNT"))) +
theme(legend.position = "none",
panel.grid.major = element_blank(),
axis.ticks = element_blank(),
axis.title.x = element_text(angle = 90, vjust = 1, color = "black"),
panel.border = element_rect(fill = NA),
axis.text.x =element_text(size=8,angle = 90) )
print(pairs.chrt, left = 0.5, bottom = 0.35)
smho. <- smho
smho.$hosp.type <- as.factor(smho.$hosp.type)
smho.$FINDIRCT  <- as.factor(smho.$FINDIRCT)
lmod1 <- lm(EXPTOTAL ~ SEENCNT + EOYCNT + FINDIRCT + hosp.type:BEDS, data=smho.)
tab.model <- xtable(summary(lmod1),digits = 2,caption = "Model Summary")
print(tab.model,caption.placement = "top")
smho. <-   # before sampling order the data set by hospital type
smho.[order(smho.$hosp.type),]
x <- smho.[,"BEDS"]
x[x <= 5] <- 5      # recode small hospitals to have a minimum size
x <- sqrt(x)
n <- 80             #sample size
IP  <- n*x/sum(x)
set.seed(428274453)
sam <- UPsystematic(IP)
sam.dat <- smho.[sam==1, ]
sam.dat$d <- 1/IP[sam==1] #the design weight
sam.dsgn <-
svydesign(ids = ~1,               # no clusters
strata = NULL,          # no strata
data = sam.dat,         # the sample data
weights = ~d)           # the design weight
#the model we use for the GREG
lmod2 <- lm(EXPTOTAL ~ SEENCNT + EOYCNT + hosp.type:BEDS, data=smho.)
#2. compute pop totals of auxiliaries
pop.tots <- colSums(model.matrix(lmod2)) #Inefficient but convenient!
#3. use 'calibrate' to compute the new weights
sam.cal <-
calibrate(design = sam.dsgn,
formula = ~ SEENCNT + EOYCNT + hosp.type:BEDS,
population = pop.tots,
calfun='linear' )
svytotal(~SEENCNT+EOYCNT, sam.cal)
?smho.N874
svyby(~EXPTOTAL, by=~hosp.type, design=sam.cal, FUN=svytotal)
set.seed(428274453)
sam <- UPsystematic(IP)
sam.dat <- smho.[sam==1, ]
sam.dat$IP <- IP[sam==1]   #the design weight
sam.dsgn <-
svydesign(ids = ~1         # no clusters
,data = sam.dat   # the sample data
,fpc = ~IP        # incl. prob
,pps= "brewer"    # variance approx. method
,variance="YG")   # Variance est. type
sam.dsgn <-
svydesign( ids = ~1         # no clusters
,data = sam.dat   # the sample data
,fpc = ~IP        # incl. prob
,pps= "brewer")    # variance approx. method
lmod2 <- lm(EXPTOTAL ~ SEENCNT + EOYCNT + hosp.type:BEDS, data=smho.)
pop.tots <- colSums(model.matrix(lmod2)) #Inefficient but convenient!
sam.cal <-
calibrate(design = sam.dsgn,
formula = ~ SEENCNT + EOYCNT + hosp.type:BEDS,
population = pop.tots,
calfun='linear' )
e
svyby(~BEDS, by=~hosp.type, design=sam.cal, FUN=svytotal)
svytotal(~SEENCNT+EOYCNT, sam.cal)
pop.tots
svytotal(~EXPTOTAL, sam.cal)
svytotal(~EXPTOTAL, sam.dsgn)
SE(svytotal(~EXPTOTAL, sam.cal))
SE(svytotal(~EXPTOTAL, sam.dsgn))
svytotal(~EXPTOTAL, sam.cal)/svytotal(~EXPTOTAL, sam.dsgn)
svyby(~EXPTOTAL, by=~hosp.type, design=sam.cal, FUN=svytotal)
svyby(~EXPTOTAL, by=~hosp.type, design=sam.dsgn, FUN=svytotal)
pop.tots
tapply(smho.$BEDS,smho.$hosp.type,sum)
table(smho.$hosp.type)
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
ori.opt <- options()
options( scipen = 5, digits = 6 )
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
options( scipen = 2, digits = 6 )
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
options( scipen = 2, digits = 3 )
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
options( scipen = 0, digits = 2 )
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
options( scipen = 1, digits = 2 )
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
options( scipen = 0, digits = 5 )
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
options( scipen = 0)
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
options( scipen = -1)
svytotal(~EXPTOTAL, sam.dsgn)
svytotal(~EXPTOTAL, sam.cal)
var(svytotal(~EXPTOTAL, sam.dsgn))
SEr(svytotal(~EXPTOTAL, sam.dsgn))
SE(svytotal(~EXPTOTAL, sam.dsgn))
SE(svytotal(~EXPTOTAL, sam.dsgn))^2
vcov(svytotal(~EXPTOTAL, sam.dsgn))
vcov(svytotal(~EXPTOTAL, sam.dsgn))/vcov(svytotal(~EXPTOTAL, sam.cal))
SE(svytotal(~EXPTOTAL, sam.dsgn))/SE(svytotal(~EXPTOTAL, sam.cal))
181.66+51.67
clu <- matrix(1:25 ,ncol=5, byrow=T)
clu.  <- cbind(clu,  rowMeans(clu))
clu.  <- rbind(clu., colMeans(clu.))
clu.  <- rbind(clu., c(apply(clu,2,var),NA))
clu.  <- cbind(clu., c(apply(clu,1,var),NA,var(as.vector(clu) )))
dimnames(clu.) <- list(  c(as.character(c(1:5)),"$\\mu_{.j}$","$V^2_{.j}$")
, c(as.character(c(1:5)),"$\\mu_{i.}$","$V^2_{i.}$"))
clu
clu
SSW.byrow <- sum(apply(clu,1,function(x)sum((x-mean(x))^2)))
SSW.bycol <- sum(apply(clu,2,function(x)sum((x-mean(x))^2)))
delta.byrow <- 1 - (SSW.byrow/(length(clu)-nrow(clu)))/var(as.vector(clu))
delta.bycol <- 1 - (SSW.bycol/(length(clu)-ncol(clu)))/var(as.vector(clu))
deff.byrow <- 1 + (length(clu)-nrow(clu))/(nrow(clu)-1)*delta.byrow
deff.bycol <- 1 + (length(clu)-nrow(clu))/(nrow(clu)-1)*delta.bycol
deffs <- matrix(c(delta.bycol, delta.byrow, deff.bycol, deff.byrow),ncol=2,byrow=T)
deffs
clu.data <- as.vector(clu)
clu.data
rep(1:5,each=5)
rep(1:5,5)
n_I <- 2
n_i <- rep(5,n_I)
n <- sum(n_i)
(n - sum( n_i^2/n, na.rm=TRUE))/(n_I-1)
anova(lm( clu.data ~ psu.col))
psu.col  <- rep(1:5,each=5)
psu.row  <- rep(1:5,5)
anova(lm( clu.data ~ psu.col))[["Mean Sq"]]
MS.row <- anova(lm( clu.data ~ psu.row))[["Mean Sq"]]
MS.row
MS.row
anova(lm( clu.data ~ psu.row))
anova(lm( clu.data ~ psu.row))["Mean Sq"]
MS.col["psu",]
MS.col <- anova(lm( clu.data ~ psu.col))[["Mean Sq"]]
MS.row <- anova(lm( clu.data ~ psu.row))["Mean Sq"]
MS.col["psu",]
MS.col["psu.row",]
MS.col <- anova(lm( clu.data ~ psu.col))["Mean Sq"]
MS.col["psu",]
(MS.col["psu",]-MS.col["Residual",]))
(MS.col["psu",]-MS.col["Residual",])
rho <- (MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
K <- (n - sum( n_i^2/n, na.rm=TRUE))/(n_I-1)
K <- (n - sum( n_i^2/n))/(n_I-1)
K
(MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
(MS.row["psu",]-MS.row["Residual",])/(MS.row["psu",]+(K-1)*MS.row["Residual",])
sum(n_i^2)/n
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
b.star <- sum(n_i^2)/n
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
rho.col <- (MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
rho.row <- (MS.row["psu",]-MS.row["Residual",])/(MS.row["psu",]+(K-1)*MS.row["Residual",])
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
deff.bycol.m
deff.byrow.m
deffs <- matrix(c(rho.col, delta.bycol.m, rho.row, deff.byrow.m),ncol=2)
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
deffs <- matrix(c(rho.col, delta.bycol.m, rho.row, deff.byrow.m),ncol=2)
deffs <- matrix(c(rho.col, deff.bycol.m, rho.row, deff.byrow.m),ncol=2)
deffs
1+(b.star - 1)*rho.col
1+(b.star - 1)*rho.row
rho.col
rho.row
SSW.byrow <- sum(apply(clu,1,function(x)sum((x-mean(x))^2)))
SSW.bycol <- sum(apply(clu,2,function(x)sum((x-mean(x))^2)))
delta.byrow <- 1 - (SSW.byrow/(length(clu)-nrow(clu)))/var(as.vector(clu))
delta.bycol <- 1 - (SSW.bycol/(length(clu)-ncol(clu)))/var(as.vector(clu))
delta.byrow
delta.bycol
clu.data <- as.vector(clu)
psu.col  <- rep(1:5,each=5)
psu.row  <- rep(1:5,5)
n_I <- 2
n_i <- rep(5,n_I)
n <- sum(n_i)
K <- (n - sum( n_i^2/n))/(n_I-1)
b.star <- sum(n_i^2)/n
MS.col <- anova(lm( clu.data ~ psu.col))["Mean Sq"]
MS.row <- anova(lm( clu.data ~ psu.row))["Mean Sq"]
rho.col <- (MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
rho.row <- (MS.row["psu",]-MS.row["Residual",])/(MS.row["psu",]+(K-1)*MS.row["Residual",])
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
deffs <- matrix(c(rho.col, deff.bycol.m, rho.row, deff.byrow.m),ncol=2)
dimnames(deffs) <-
list(c("$\\rho$","$\\deff$"), c("SRCS a", "SRCS b"))
clu.data <- as.vector(clu)
psu.col  <- rep(1:5,each=5)
psu.row  <- rep(1:5,5)
n_I <- 2
n_i <- rep(5,n_I)
n <- sum(n_i)
K <- (n - sum( n_i^2/n))/(n_I-1)
b.star <- sum(n_i^2)/n
MS.col <- anova(lm( clu.data ~ psu.col))["Mean Sq"]
MS.row <- anova(lm( clu.data ~ psu.row))["Mean Sq"]
rho.col <- (MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
rho.row <- (MS.row["psu",]-MS.row["Residual",])/(MS.row["psu",]+(K-1)*MS.row["Residual",])
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
deffm <- matrix(c(rho.col, deff.bycol.m, rho.row, deff.byrow.m),ncol=2)
dimnames(deffm) <-
list(c("$\\rho$","$\\deff$"), c("SRCS a", "SRCS b"))
deffm.tab <- xtable(deffm, digits = 5, caption = "Intra-Class Correlation Coefficient and Design Effects")
align(deffm.tab ) <- "l|rr"
print.xtable(deffm.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
library(xtable)
clu.data <- as.vector(clu)
psu.col  <- rep(1:5,each=5)
psu.row  <- rep(1:5,5)
n_I <- 2
n_i <- rep(5,n_I)
n <- sum(n_i)
K <- (n - sum( n_i^2/n))/(n_I-1)
b.star <- sum(n_i^2)/n
MS.col <- anova(lm( clu.data ~ psu.col))["Mean Sq"]
MS.row <- anova(lm( clu.data ~ psu.row))["Mean Sq"]
rho.col <- (MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
rho.row <- (MS.row["psu",]-MS.row["Residual",])/(MS.row["psu",]+(K-1)*MS.row["Residual",])
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
deffm <- matrix(c(rho.col, deff.bycol.m, rho.row, deff.byrow.m),ncol=2)
dimnames(deffm) <-
list(c("$\\rho$","$\\deff$"), c("SRCS a", "SRCS b"))
deffm.tab <- xtable(deffm, digits = 5, caption = "Intra-Class Correlation Coefficient and Design Effects")
align(deffm.tab ) <- "l|rr"
print.xtable(deffm.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
clu.data <- as.vector(clu)
psu.col  <- rep(1:5,each=5)
psu.row  <- rep(1:5,5)
n_I <- 2
n_i <- rep(5,n_I)
n <- sum(n_i)
K <- (n - sum( n_i^2/n))/(n_I-1)
b.star <- sum(n_i^2)/n
MS.col <- anova(lm( clu.data ~ psu.col))["Mean Sq"]
MS.row <- anova(lm( clu.data ~ psu.row))["Mean Sq"]
rho.col <- (MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
rho.row <- (MS.row["psu",]-MS.row["Residual",])/(MS.row["psu",]+(K-1)*MS.row["Residual",])
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
deffm <- matrix(c(rho.col, deff.bycol.m, rho.row, deff.byrow.m),ncol=2)
dimnames(deffm) <-
list(c("$\\rho$","$\\deff$"), c("SRCS a", "SRCS b"))
deffm.tab <- xtable(deffm, digits = 5, caption = "Intra-Class Correlation Coefficient and (Model) Design Effects")
align(deffm.tab ) <- "l|rr"
print.xtable(deffm.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
print.xtable(deffs.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
print.xtable(deffs.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
@
print.xtable(deffs.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
SSW.byrow <- sum(apply(clu,1,function(x)sum((x-mean(x))^2)))
SSW.bycol <- sum(apply(clu,2,function(x)sum((x-mean(x))^2)))
delta.byrow <- 1 - (SSW.byrow/(length(clu)-nrow(clu)))/var(as.vector(clu))
delta.bycol <- 1 - (SSW.bycol/(length(clu)-ncol(clu)))/var(as.vector(clu))
deff.byrow <- 1 + (length(clu)-nrow(clu))/(nrow(clu)-1)*delta.byrow
deff.bycol <- 1 + (length(clu)-nrow(clu))/(nrow(clu)-1)*delta.bycol
deffs <- matrix(c(delta.bycol, delta.byrow, deff.bycol, deff.byrow),ncol=2,byrow=T)
dimnames(deffs) <-
list(c("$\\delta$","$\\deff$"), c("SRCS a", "SRCS b"))
deffs.tab <- xtable(deffs, digits = 5, caption = "Intra-Cluster Homogeneity and Design Effects")
align(deffs.tab ) <- "l|rr"
print.xtable(clu.tab,hline.after = c(0,5,6),caption.placement="top", sanitize.text.function = identity)
print.xtable(deffs.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
SSW.byrow <- sum(apply(clu,1,function(x)sum((x-mean(x))^2)))
SSW.bycol <- sum(apply(clu,2,function(x)sum((x-mean(x))^2)))
delta.byrow <- 1 - (SSW.byrow/(length(clu)-nrow(clu)))/var(as.vector(clu))
delta.bycol <- 1 - (SSW.bycol/(length(clu)-ncol(clu)))/var(as.vector(clu))
deff.byrow <- 1 + (length(clu)-nrow(clu))/(nrow(clu)-1)*delta.byrow
deff.bycol <- 1 + (length(clu)-nrow(clu))/(nrow(clu)-1)*delta.bycol
deffs <- matrix(c(delta.bycol, delta.byrow, deff.bycol, deff.byrow),ncol=2,byrow=T)
dimnames(deffs) <-
list(c("$\\delta$","$\\deff$"), c("SRCS a", "SRCS b"))
deffs.tab <- xtable(deffs, digits = 5, caption = "Intra-Cluster Homogeneity and Design Effects")
align(deffs.tab ) <- "l|rr"
print.xtable(clu.tab,hline.after = c(0,5,6),caption.placement="top", sanitize.text.function = identity)
print.xtable(deffs.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
clu.data <- as.vector(clu)
psu.col  <- rep(1:5,each=5)
psu.row  <- rep(1:5,5)
n_I <- 2
n_i <- rep(5,n_I)
n <- sum(n_i)
K <- (n - sum( n_i^2/n))/(n_I-1)
b.star <- sum(n_i^2)/n
MS.col <- anova(lm( clu.data ~ psu.col))["Mean Sq"]
MS.row <- anova(lm( clu.data ~ psu.row))["Mean Sq"]
rho.col <- (MS.col["psu",]-MS.col["Residual",])/(MS.col["psu",]+(K-1)*MS.col["Residual",])
rho.row <- (MS.row["psu",]-MS.row["Residual",])/(MS.row["psu",]+(K-1)*MS.row["Residual",])
deff.bycol.m <- 1+(b.star - 1)*rho.col
deff.byrow.m <- 1+(b.star - 1)*rho.row
deffm <- matrix(c(rho.col, deff.bycol.m, rho.row, deff.byrow.m),ncol=2)
dimnames(deffm) <-
list(c("$\\rho$","$\\deff$"), c("SRCS a", "SRCS b"))
deffm.tab <- xtable(deffm, digits = 5, caption = "Intra-Class Correlation Coefficient and (Model) Design Effects")
align(deffm.tab ) <- "l|rr"
print.xtable(deffm.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
print.xtable(deffs.tab, hline.after = 0,  caption.placement="top", sanitize.text.function = identity)
deffs[-1,]
xtable(deffs[-1,], digits = 5, caption = "Intra-Cluster Homogeneity and Design Effects")
class(deffs[-1,])
class(deffs)
deffs.tab <- xtable(deffs[-1,,drop=F], digits = 5, caption = "Intra-Cluster Homogeneity and Design Effects")
deffs.tab
=======
install.packages("alabama")
install.packages("PracTools")
5862+2974+1619+561+467+196+163
4806+2394+1267+450+404+161+131
2617*.684
2617-1790
48.5+5.4
34.7+1.8
31169+5195+3306+3967+11563+22105+10316+15474
11132+1855+1181+1416+4216+7895+3684+5526
14000+7000+14000+13999
3684+1842+3684+3683
600*.6
1200/21
library(knitr)
Sweave2knitr("Ex1.Rnw")
Sweave2knitr("H:/Sand_Summerschool/SamplingAndEsimation/tutorial/Exercises/Exercise1/x1.Rnw")
Sweave2knitr("H:/Sand_Summerschool/SamplingAndEsimation/tutorial/Exercises/Exercise1/Ex1.Rnw")
library(survey)
data(api)
View(apisrs)
library(foreign)
library(survey)
path <- "F:/ESS Data/"
path.ger <- "F:/ESS Data/Germany/"
path.net <- "F:/ESS Data/Netherlands/"
setwd(path)
#### Germany ####
Ger.d <- read.spss(paste(path.ger,"ESS5DE.spss/ESS5DE.sav",sep=""),to.data.frame = TRUE)
Ger.ctry <- read.spss(paste(path.ger,"ESS5_DE_SDDF.spss/ESS5_DE_SDDF.por",sep=""),to.data.frame = TRUE, use.value.labels = TRUE)
colnames(Ger.d)[5] <- "IDNO"
Ger <- merge(Ger.d,Ger.ctry,by="IDNO", all.x = TRUE)
Ger$PSU <- as.factor(Ger$PSU)
n <- nrow(Ger)
L <- length(unique(Ger$PSU))
## deffp
df.tab <- as.data.frame(table(Ger$PSU,Ger$dweight))
head(deff.tab)
deff.tab <- subset(df.tab,df.tab[,3]!=0)
deff.tab[,2] <- as.numeric(as.character(deff.tab[,2]))
deff_p <- n*sum(deff.tab[,3]*deff.tab[,2]^2)/(sum(deff.tab[,3]*deff.tab[,2])^2)
## deffc
b <- sum(tapply(Ger$dweight,Ger$PSU,function(x)sum(x)^2))/sum(Ger$dweight^2)
SS <- anova(lm(as.numeric(Ger$agea)~Ger$PSU))
MSB <- SS$`Mean Sq`[1]
MSW <- SS$`Mean Sq`[2]
K <- 1/(L-1)*(n-sum(deff.tab[,3]^2/n))
rho <- (MSB-MSW)/(MSB+(K-1)*MSW)
deff_c <- 1+(b-1)*rho
## deff
deff <- deff_p*deff_c
deff
View(SS)
neff <- nrow(Ger)/deff
neff
library("knitr", lib.loc="~/R/win-library/3.1")
Sweave2knitr(Day1.Rnw)
Sweave2knitr("H:/Sand_Summerschool/SamplingAndEsimation/tutorial/slides/Part1/Day1.Rnw")
800/13
480/13
>>>>>>> c03ec1f0a8ea50c4f1628e64a69f7640a95e28ed
