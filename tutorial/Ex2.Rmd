---
title: "Exercise 2"
author: "Jan-Philipp Kolb, Stefan Zins and Matthias Sand"
date: "1. Februar 2016"
output: html_document
---

```{r,echo=F}
Ex <- F
library(knitr)
```



## Example A

Estimation for the European Social Survey under stratified design

- Download ESS for Sweden and Denmark
- Import data to R and merge the two datasets
- Define a `survey` object (stratified design)
- Calculate the unbiased totals for the tv consumption 

## Download and Import ESS

- Download the ESS dataset for [Denmark](http://www.europeansocialsurvey.org/file/download?f=ESS5DK.spss.zip&c=DK&y=2010) (Sampling Data and Country File) of the 5th round

Packages for data import

- Use the package `foreign` or `memisc` for import

```{r,message=F,warning=F}
library(foreign)
```

```{r,message=F,warning=F}
library(memisc)
```



```{r,echo=F}
## Set working directory
main.path <- "J:/Work/Statistik/Kolb/Workshops/2016/grade_sampling/"

data.path <- paste(main.path,"data/",sep="")

setwd(data.path)
```


## Load the ESS dataset and the country file


[Import portable spss-files](http://stackoverflow.com/questions/3136293/read-spss-file-into-r)

```{r,eval=Ex}
DK <- as.data.set(spss.portable.file("ESS5DK.por"))
SE <- as.data.set(spss.portable.file("ESS5SE.por"))
```


```{r,eval=Ex}
DK <- as.data.frame(DK)
DK$N <- DK$pweight*10000*nrow(DK)

SE <- as.data.frame(SE)
SE$N <- SE$pweight*10000*nrow(SE)
```

```{r,eval=Ex}
DK_tv <- data.frame(tvtot=as.character(DK$tvtot),
                    N=DK$N,
                    cntry=as.character(DK$cntry))
SE_tv <- data.frame(tvtot=as.character(SE$tvtot),
                    N=SE$N,
                    cntry=as.character(SE$cntry))


NE <- rbind(DK_tv,SE_tv)
```

## Define a survey object

```{r,message=F}
library(survey)
```


[Define a survey object:](http://r-survey.r-forge.r-project.org/survey/example-design.html)

```{r,eval=Ex}
svydes_NE <- svydesign(id=~1,strata=~cntry, fpc=~N, data=NE)
```

```{r,eval=Ex}
svytable(~tvtot,svydes_NE)
```



## Example B

- Load the survey package and the `api` datasets.

- Compute the mean of the Academic Performance Index (2000),  asuming SRS

- Use other allocations

- Select a StrSRS from apipop for each allocations.

- Estimate the mean of api00 from different
samples (equal, proportional, optimal).

## The survey library

Load `survey` library and dataset apistrat

```{r,message=F}
library(survey)
```


The dataset apistrat is a sample of schools from apipop
stratified by stype. 

```{r}
data(api)
```

```{r,eval=F}
head(apistrat)
```

```{r,echo=F}
kable(apistrat[1:8,1:5])
```


## Stratified designs

Assuming the selection within the
strata was done by SRS, define a svydesign object that
enables you to make unbiased point and variance
estimates. 

- Estimate the mean of variable `api00`.

```{r}
mean(apistrat$api00)
```

## Allocations

Now you should try different allocations. 

Using `stype` as a stratification variable calculate the allocation of a sample of 60 schools from apipop. Use

- equal allocation
- proportional allocation (proportional to nr. of schools)
- optimal allocation (with regard to `api99` allocation)

Select a StrSRS from apipop for each of your allocations.

- Estimate again the mean of api00 from your three different
samples.

```{r,eval=F}
library(devtools)

install_github("BernStZi/SamplingAndEstimation/r/sampaest",ref="short")
```
